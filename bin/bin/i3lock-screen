#!/bin/bash

# Setting the blur type for ImageMagick
blur_type="0x8"

# Setting the lock icon location
lock_image="$HOME/.config/i3/resources/lock.png"

# Setting the output image location
out_image="/tmp/i3lock.png"

# Define the regex for both the lock image info and display info
lock_image_regex="([0-9]+)x([0-9]+)"
display_regex="([0-9]+)x([0-9]+)\\+([0-9]+)\\+([0-9]+)"

# Declare the lock image parameters variable for ImageMagick later
lock_image_params=""


# Take a screenshot of the screen using maim
maim > $out_image

# Get the width and height of the lock icon
[[ `identify $lock_image` =~ $lock_image_regex ]]
lock_image_width=${BASH_REMATCH[1]}
lock_image_height=${BASH_REMATCH[2]}

# Pull display information from xrandr
while read line
do
     if [[ $line =~ $display_regex ]]; then
          # Store the output image dimensions in easily-readable variables...
          out_image_width=${BASH_REMATCH[1]}
          out_image_height=${BASH_REMATCH[2]}
          out_image_x=${BASH_REMATCH[3]}
          out_image_y=${BASH_REMATCH[4]}
          
          # ... and utilise them here to determine the center values of each display
          lock_image_x=$(($out_image_x+$out_image_width/2-$lock_image_width/2))
          lock_image_y=$(($out_image_y+$out_image_height/2-$lock_image_height/2))

          # Store the output information in a variable
          lock_image_params="$lock_image_params '$lock_image' '-geometry' '+$lock_image_x+$lock_image_y' '-composite'"
     fi
done <<<"`xrandr`"

# Run ImageMagick with the required parameters
output_image_params="'$out_image' '-level' '0%,100%,0.6' '-blur' '$blur_type' $lock_image_params '$out_image'"
eval convert $output_image_params

# Run i3lock with the output image from ImageMagick
i3lock -i $out_image -t -e -u -n

# Finally, remove the output image and end the script
rm $out_image
